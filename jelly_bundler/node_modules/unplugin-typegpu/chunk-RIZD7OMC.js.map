{"version":3,"sources":["../src/index.ts","../src/rollup-impl.ts","../src/rolldown-browser.ts"],"sourcesContent":["import { createUnplugin } from 'unplugin';\nimport { rollUpImpl } from './rollup-impl.ts';\n\nconst typegpu = createUnplugin(rollUpImpl);\n\nexport type { Options } from './common.ts';\n\nexport default typegpu;\n\nexport const vitePlugin = typegpu.vite;\nexport const rollupPlugin = typegpu.rollup;\nexport const rolldownPlugin = typegpu.rolldown;\nexport const webpackPlugin = typegpu.webpack;\nexport const rspackPlugin = typegpu.rspack;\nexport const esbuildPlugin = typegpu.esbuild;\nexport const farmPlugin = typegpu.farm;\n\nexport { default as babelPlugin } from './babel.ts';\nexport { default as bunPlugin } from './bun.ts';\nexport { default as rolldownBrowserPlugin } from './rolldown-browser.ts';\n","import type * as acorn from 'acorn';\nimport defu from 'defu';\nimport { generateTransform, MagicStringAST } from 'magic-string-ast';\nimport {\n  type Context,\n  defaultOptions,\n  earlyPruneRegex,\n  embedJSON,\n  gatherTgpuAliases,\n  getFunctionName,\n  isShellImplementationCall,\n  type Options,\n  performExpressionNaming,\n  useGpuDirective,\n} from './common.ts';\nimport type { UnpluginBuildContext, UnpluginContext } from 'unplugin';\nimport { type Node, walk } from 'estree-walker';\nimport { transpileFn } from 'tinyest-for-wgsl';\nimport { FORMAT_VERSION } from 'tinyest';\n\nexport type FunctionNode =\n  | acorn.FunctionDeclaration\n  | acorn.AnonymousFunctionDeclaration\n  | acorn.FunctionExpression\n  | acorn.ArrowFunctionExpression;\n\nexport function containsUseGpuDirective(node: FunctionNode): boolean {\n  if (node.body.type === 'BlockStatement') {\n    for (const statement of node.body.body) {\n      if (\n        statement.type === 'ExpressionStatement' &&\n        statement.directive === useGpuDirective\n      ) {\n        return true;\n      }\n    }\n  }\n  return false;\n}\n\nexport function removeUseGpuDirective(node: FunctionNode) {\n  const cloned = structuredClone(node);\n\n  if (cloned.body.type === 'BlockStatement') {\n    cloned.body.body = cloned.body.body.filter(\n      (statement) =>\n        !(\n          statement.type === 'ExpressionStatement' &&\n          statement.directive === useGpuDirective\n        ),\n    );\n  }\n\n  return cloned;\n}\n\nexport function assignMetadata(\n  magicString: MagicStringAST,\n  node: acorn.AnyNode,\n  metadata: string,\n) {\n  magicString.prependLeft(\n    node.start,\n    '(($ => (globalThis.__TYPEGPU_META__ ??= new WeakMap()).set($.f = (',\n  ).appendRight(\n    node.end,\n    `), ${metadata}) && $.f)({}))`,\n  );\n}\n\nexport function wrapInAutoName(\n  magicString: MagicStringAST,\n  node: acorn.Node,\n  name: string,\n) {\n  magicString\n    .prependLeft(\n      node.start,\n      '((globalThis.__TYPEGPU_AUTONAME__ ?? (a => a))(',\n    )\n    .appendRight(node.end, `, \"${name}\"))`);\n}\n\nexport const rollUpImpl = (rawOptions: Options) => {\n  const options = defu(rawOptions, defaultOptions);\n\n  return {\n    name: 'unplugin-typegpu' as const,\n    enforce: options.enforce,\n    transform: {\n      filter: options.earlyPruning\n        ? {\n          id: options,\n          code: earlyPruneRegex,\n        }\n        : {\n          id: options,\n        },\n      handler(\n        this: UnpluginBuildContext & UnpluginContext,\n        code: string,\n        id: string,\n      ) {\n        const ctx: Context = {\n          tgpuAliases: new Set<string>(\n            options.forceTgpuAlias ? [options.forceTgpuAlias] : [],\n          ),\n          fileId: id,\n          autoNamingEnabled: options.autoNamingEnabled,\n        };\n\n        let ast: Node;\n        try {\n          ast = this.parse(code, {\n            lang: 'ts',\n            allowReturnOutsideFunction: true,\n          }) as Node;\n        } catch (cause) {\n          console.warn(\n            `[unplugin-typegpu] Failed to parse ${id}. Cause: ${\n              typeof cause === 'object' && cause && 'message' in cause\n                ? cause.message\n                : cause\n            }`,\n          );\n          return undefined;\n        }\n\n        const tgslFunctionDefs: {\n          def: FunctionNode;\n          name?: string | undefined;\n        }[] = [];\n\n        const magicString = new MagicStringAST(code);\n\n        walk(ast, {\n          enter(_node, _parent, prop, index) {\n            const node = _node as acorn.AnyNode;\n            const parent = _parent as acorn.AnyNode;\n\n            performExpressionNaming(ctx, node, (node, name) => {\n              wrapInAutoName(magicString, node, name);\n            });\n\n            if (node.type === 'ImportDeclaration') {\n              gatherTgpuAliases(node, ctx);\n            }\n\n            if (node.type === 'CallExpression') {\n              if (isShellImplementationCall(node, ctx)) {\n                const implementation = node.arguments[0];\n\n                if (\n                  implementation &&\n                  (implementation.type === 'FunctionExpression' ||\n                    implementation.type === 'ArrowFunctionExpression')\n                ) {\n                  tgslFunctionDefs.push({\n                    def: removeUseGpuDirective(implementation),\n                  });\n                  this.skip();\n                }\n              }\n            }\n\n            if (\n              node.type === 'ArrowFunctionExpression' ||\n              node.type === 'FunctionExpression' ||\n              node.type === 'FunctionDeclaration'\n            ) {\n              if (containsUseGpuDirective(node)) {\n                tgslFunctionDefs.push({\n                  def: removeUseGpuDirective(node),\n                  name: getFunctionName(node, parent),\n                });\n                this.skip();\n              }\n            }\n          },\n        });\n\n        for (const { def, name } of tgslFunctionDefs) {\n          const { params, body, externalNames } = transpileFn(def);\n          const isFunctionStatement = def.type === 'FunctionDeclaration';\n\n          if (\n            isFunctionStatement &&\n            name &&\n            code.slice(0, def.start)\n                .search(new RegExp(`(?<![\\\\w_.])${name}(?![\\\\w_])`)) !== -1\n          ) {\n            console.warn(\n              `File ${id}: function \"${name}\" might have been referenced before its usage. Function statements are no longer hoisted after being transformed by the plugin.`,\n            );\n          }\n\n          const metadata = `{\n              v: ${FORMAT_VERSION},\n              name: ${name ? `\"${name}\"` : 'undefined'},\n              ast: ${embedJSON({ params, body, externalNames })},\n              externals: () => ({${\n            externalNames.map((e) => e === 'this' ? '\"this\": this' : e).join(\n              ', ',\n            )\n          }}),\n            }`;\n\n          assignMetadata(magicString, def, metadata);\n\n          if (isFunctionStatement && name) {\n            magicString.prependLeft(def.start, `const ${name} = `);\n          }\n        }\n\n        return generateTransform(magicString, id);\n      },\n    },\n  };\n};\n","import { rollUpImpl } from './rollup-impl.ts';\n\n// The unplugin API is based on the rollup/rolldown APIs, so it\n// should just be a compatible rolldown plugin.\nexport default rollUpImpl;\n"],"mappings":"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","names":["createUnplugin","defu","generateTransform","MagicStringAST","walk","transpileFn","FORMAT_VERSION","containsUseGpuDirective","node","statement","useGpuDirective","removeUseGpuDirective","cloned","assignMetadata","magicString","metadata","wrapInAutoName","name","rollUpImpl","rawOptions","options","defu","defaultOptions","earlyPruneRegex","code","id","ctx","ast","cause","tgslFunctionDefs","MagicStringAST","_node","_parent","prop","index","parent","performExpressionNaming","gatherTgpuAliases","isShellImplementationCall","implementation","getFunctionName","def","params","body","externalNames","isFunctionStatement","embedJSON","e","generateTransform","rolldown_browser_default","rollUpImpl","typegpu","createUnplugin","rollUpImpl","index_default","vitePlugin","rollupPlugin","rolldownPlugin","webpackPlugin","rspackPlugin","esbuildPlugin","farmPlugin"]}